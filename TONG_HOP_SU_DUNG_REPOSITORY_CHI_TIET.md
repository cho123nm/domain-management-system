# üìö **T·ªîNG H·ª¢P CHI TI·∫æT S·ª¨ D·ª§NG REPOSITORY TRONG H·ªÜ TH·ªêNG**

## üéØ **T·ªîNG QUAN**

T√†i li·ªáu n√†y t·ªïng h·ª£p chi ti·∫øt t·∫•t c·∫£ c√°c h√†m Repository ƒë∆∞·ª£c s·ª≠ d·ª•ng trong t·ª´ng file c·ªßa h·ªá th·ªëng, bao g·ªìm:

- **File n√†o s·ª≠ d·ª•ng h√†m n√†o**
- **Ch·ª©c nƒÉng c·ª• th·ªÉ c·ªßa t·ª´ng h√†m**
- **Lu·ªìng x·ª≠ l√Ω v√† m·ª•c ƒë√≠ch s·ª≠ d·ª•ng**

---

## üë§ **USERREPOSITORY - QU·∫¢N L√ù NG∆Ø·ªúI D√ôNG**

### **üìã Danh s√°ch c√°c h√†m:**

| H√†m                   | M√¥ t·∫£                     | Tham s·ªë                                                              | Tr·∫£ v·ªÅ        |
| --------------------- | ------------------------- | -------------------------------------------------------------------- | ------------- |
| `findByUsername()`    | T√¨m user theo username    | `string $username`                                                   | `array\|null` |
| `verifyCredentials()` | X√°c th·ª±c ƒëƒÉng nh·∫≠p        | `string $username, string $password`                                 | `bool`        |
| `listAll()`           | L·∫•y danh s√°ch t·∫•t c·∫£ user | -                                                                    | `array`       |
| `countAll()`          | ƒê·∫øm t·ªïng s·ªë user          | -                                                                    | `int`         |
| `updateBalance()`     | C·∫≠p nh·∫≠t s·ªë d∆∞ tuy·ªát ƒë·ªëi  | `int $userId, int $amount`                                           | `bool`        |
| `incrementBalance()`  | TƒÉng s·ªë d∆∞                | `int $userId, int $delta`                                            | `bool`        |
| `createUser()`        | T·∫°o user m·ªõi              | `string $username, string $passwordMd5, string $email, string $time` | `bool`        |
| `findById()`          | T√¨m user theo ID          | `int $userId`                                                        | `array\|null` |
| `findByEmail()`       | T√¨m user theo email       | `string $email`                                                      | `array\|null` |
| `updateProfile()`     | C·∫≠p nh·∫≠t profile          | `int $userId, string $email, string $newUsername`                    | `bool`        |

### **üìÅ C√°c file s·ª≠ d·ª•ng UserRepository:**

#### **1. Adminstators/don-nap-vi.php**

```php
$userRepo = new UserRepository($connect);
$checkus = $userRepo->findById((int)$id);  // Ki·ªÉm tra user t·ªìn t·∫°i
$thanhright = $userRepo->incrementBalance((int)$id, (int)$price);  // C·ªông ti·ªÅn
```

**Ch·ª©c nƒÉng:** Qu·∫£n l√Ω n·∫°p ti·ªÅn th·ªß c√¥ng cho user

#### **2. Adminstators/quan-ly-thanh-vien.php**

```php
$userRepo = new UserRepository($connect);
$resultRows = $userRepo->listAll();  // L·∫•y danh s√°ch t·∫•t c·∫£ user
$userRepo->updateBalance($userId, $newBalance);  // C·∫≠p nh·∫≠t s·ªë d∆∞
```

**Ch·ª©c nƒÉng:** Qu·∫£n l√Ω danh s√°ch th√†nh vi√™n v√† c·∫≠p nh·∫≠t s·ªë d∆∞

#### **3. Adminstators/index.php**

```php
$factory = new RepositoryFactory($connect);
$userRepo = $factory->users();
$totalUsers = $userRepo->countAll();  // ƒê·∫øm t·ªïng s·ªë user
```

**Ch·ª©c nƒÉng:** Dashboard th·ªëng k√™ t·ªïng quan

#### **4. Pages/account_profile.php**

```php
$userRepo = new UserRepository($connect);
$user = $userRepo->findByUsername($currentUsername);  // L·∫•y th√¥ng tin user hi·ªán t·∫°i
```

**Ch·ª©c nƒÉng:** Hi·ªÉn th·ªã th√¥ng tin c√° nh√¢n

#### **5. Ajaxs/login.php**

```php
$userRepo = new UserRepository($connect);
if ($userRepo->verifyCredentials($taikhoan, $matkhau)) {  // X√°c th·ª±c ƒëƒÉng nh·∫≠p
    $_SESSION['users'] = $taikhoan;
}
```

**Ch·ª©c nƒÉng:** X·ª≠ l√Ω ƒëƒÉng nh·∫≠p AJAX

#### **6. Ajaxs/register.php**

```php
$userRepo = new UserRepository($connect);
if($userRepo->findByUsername($taikhoan)) {  // Ki·ªÉm tra username ƒë√£ t·ªìn t·∫°i
    // B√°o l·ªói
} else if($userRepo->findByEmail($email)) {  // Ki·ªÉm tra email ƒë√£ t·ªìn t·∫°i
    // B√°o l·ªói
} else {
    $userRepo->createUser($taikhoan, $matkhau, $email);  // T·∫°o user m·ªõi
}
```

**Ch·ª©c nƒÉng:** X·ª≠ l√Ω ƒëƒÉng k√Ω AJAX

#### **7. Controllers/ViewController.php**

```php
$this->userRepo = new UserRepository($connect);
$user = $this->userRepo->findByUsername($_SESSION['users']);  // L·∫•y th√¥ng tin user
```

**Ch·ª©c nƒÉng:** Controller x·ª≠ l√Ω view

#### **8. Controllers/DomainController.php**

```php
$this->userRepo = new UserRepository($connect);
$user = $this->userRepo->findByUsername($_SESSION['users']);  // L·∫•y th√¥ng tin user
```

**Ch·ª©c nƒÉng:** Controller x·ª≠ l√Ω domain

#### **9. Controllers/AjaxController.php**

```php
$this->userRepo = new UserRepository($connect);
$user = $this->userRepo->findByUsername($_SESSION['users']);  // L·∫•y th√¥ng tin user
```

**Ch·ª©c nƒÉng:** Controller x·ª≠ l√Ω AJAX

#### **10. Controllers/AdminController.php**

```php
$this->userRepo = new UserRepository($connect);
$users = $this->userRepo->listAll();  // L·∫•y danh s√°ch user
```

**Ch·ª©c nƒÉng:** Controller x·ª≠ l√Ω admin

#### **11. Controllers/AuthController.php**

```php
$this->userRepo = new UserRepository($connect);
if ($this->userRepo->verifyCredentials($username, $password)) {  // X√°c th·ª±c
    // X·ª≠ l√Ω ƒëƒÉng nh·∫≠p
}
```

**Ch·ª©c nƒÉng:** Controller x·ª≠ l√Ω x√°c th·ª±c

#### **12. Controllers/BaseController.php**

```php
$userRepo = new UserRepository($this->connect);
return $userRepo->findByUsername($_SESSION['users']);  // L·∫•y user hi·ªán t·∫°i
```

**Ch·ª©c nƒÉng:** Controller c∆° s·ªü

#### **13. Controllers/CardController.php**

```php
$this->userRepo = new UserRepository($connect);
$user = $this->userRepo->findByUsername($_SESSION['users']);  // L·∫•y th√¥ng tin user
```

**Ch·ª©c nƒÉng:** Controller x·ª≠ l√Ω th·∫ª c√†o

#### **14. Config/Database.php**

```php
$userRepo = new UserRepository($connect);
$users = $userRepo->findByUsername($_SESSION['users']);  // L·∫•y th√¥ng tin user
```

**Ch·ª©c nƒÉng:** C·∫•u h√¨nh database

#### **15. Pages/ManagesWhois.php**

```php
$userRepo = new UserRepository($connect);
$currentUser = $userRepo->findByUsername($_SESSION['users']);  // L·∫•y user hi·ªán t·∫°i
```

**Ch·ª©c nƒÉng:** Qu·∫£n l√Ω Whois

#### **16. callback.php**

```php
$userRepo = new UserRepository($connect);
$userRepo->incrementBalance($uid, (int)$value_customer_receive);  // C·ªông ti·ªÅn t·ª´ callback
```

**Ch·ª©c nƒÉng:** X·ª≠ l√Ω callback t·ª´ API th·∫ª c√†o

#### **17. Ajaxs/UpdateDns.php**

```php
$userRepo = new UserRepository($connect);
$currentUser = $userRepo->findByUsername($_SESSION['users']);  // L·∫•y user hi·ªán t·∫°i
```

**Ch·ª©c nƒÉng:** C·∫≠p nh·∫≠t DNS

---

## üåê **DOMAINREPOSITORY - QU·∫¢N L√ù T√äN MI·ªÄN**

### **üìã Danh s√°ch c√°c h√†m:**

| H√†m              | M√¥ t·∫£                       | Tham s·ªë                                            | Tr·∫£ v·ªÅ        |
| ---------------- | --------------------------- | -------------------------------------------------- | ------------- |
| `listAll()`      | L·∫•y danh s√°ch t·∫•t c·∫£ domain | -                                                  | `array`       |
| `create()`       | T·∫°o domain m·ªõi              | `int $price, string $duoi, string $image`          | `bool`        |
| `deleteById()`   | X√≥a domain theo ID          | `int $id`                                          | `bool`        |
| `findById()`     | T√¨m domain theo ID          | `int $id`                                          | `array\|null` |
| `updateById()`   | C·∫≠p nh·∫≠t domain             | `int $id, string $duoi, string $image, int $price` | `bool`        |
| `getOneSample()` | L·∫•y m·ªôt m·∫´u domain          | -                                                  | `array\|null` |
| `findByDuoi()`   | T√¨m domain theo ƒëu√¥i        | `string $duoi`                                     | `array\|null` |

### **üìÅ C√°c file s·ª≠ d·ª•ng DomainRepository:**

#### **1. Adminstators/danh-sach-san-pham.php**

```php
$domainRepo = new DomainRepository($connect);
$resultRows = $domainRepo->listAll();  // L·∫•y danh s√°ch t·∫•t c·∫£ domain
$domainRepo->deleteById((int)$id);  // X√≥a domain
```

**Ch·ª©c nƒÉng:** Qu·∫£n l√Ω danh s√°ch s·∫£n ph·∫©m

#### **2. Adminstators/them-san-pham.php**

```php
$domainRepo = new DomainRepository($connect);
$ok = $domainRepo->create((int)$price, $duoi, $image);  // T·∫°o domain m·ªõi
```

**Ch·ª©c nƒÉng:** Th√™m s·∫£n ph·∫©m m·ªõi

#### **3. Adminstators/Edit.php**

```php
$domainRepo = new DomainRepository($connect);
$cloudstorevn12 = $domainRepo->findById($domainId);  // L·∫•y th√¥ng tin domain
$ok = $domainRepo->updateById($domainId, $tieude, $image, (int)$price);  // C·∫≠p nh·∫≠t domain
```

**Ch·ª©c nƒÉng:** Ch·ªânh s·ª≠a s·∫£n ph·∫©m

#### **4. Adminstators/index.php**

```php
$factory = new RepositoryFactory($connect);
$domainRepo = $factory->domains();
```

**Ch·ª©c nƒÉng:** Dashboard admin

#### **5. Controllers/ViewController.php**

```php
$this->domainRepo = new DomainRepository($connect);
$domains = $this->domainRepo->listAll();  // L·∫•y danh s√°ch domain
```

**Ch·ª©c nƒÉng:** Controller x·ª≠ l√Ω view

#### **6. Controllers/DomainController.php**

```php
$this->domainRepo = new DomainRepository($connect);
$domain = $this->domainRepo->findByDuoi($duoi);  // T√¨m domain theo ƒëu√¥i
```

**Ch·ª©c nƒÉng:** Controller x·ª≠ l√Ω domain

#### **7. Controllers/AjaxController.php**

```php
$this->domainRepo = new DomainRepository($connect);
$domains = $this->domainRepo->listAll();  // L·∫•y danh s√°ch domain
```

**Ch·ª©c nƒÉng:** Controller x·ª≠ l√Ω AJAX

#### **8. Controllers/AdminController.php**

```php
$this->domainRepo = new DomainRepository($connect);
$domains = $this->domainRepo->listAll();  // L·∫•y danh s√°ch domain
```

**Ch·ª©c nƒÉng:** Controller x·ª≠ l√Ω admin

#### **9. Controllers/CardController.php**

```php
$this->domainRepo = new DomainRepository($connect);
```

**Ch·ª©c nƒÉng:** Controller x·ª≠ l√Ω th·∫ª c√†o

#### **10. index.php**

```php
$domainRepo = new DomainRepository($connect);
$domains = $domainRepo->listAll();  // L·∫•y danh s√°ch domain ƒë·ªÉ hi·ªÉn th·ªã
```

**Ch·ª©c nƒÉng:** Trang ch·ªß hi·ªÉn th·ªã s·∫£n ph·∫©m

#### **11. Config/Database.php**

```php
$domainRepo = new DomainRepository($connect);
$domainname = $domainRepo->getOneSample();  // L·∫•y m·∫´u domain
```

**Ch·ª©c nƒÉng:** C·∫•u h√¨nh database

#### **12. Pages/Checkout.php**

```php
$domainRepo = new DomainRepository($connect);
$fetch = $domainRepo->findByDuoi($duoimien);  // T√¨m domain theo ƒëu√¥i
```

**Ch·ª©c nƒÉng:** Trang thanh to√°n

---

## üìã **HISTORYREPOSITORY - QU·∫¢N L√ù L·ªäCH S·ª¨ GIAO D·ªäCH**

### **üìã Danh s√°ch c√°c h√†m:**

| H√†m                          | M√¥ t·∫£                                 | Tham s·ªë                                                                                         | Tr·∫£ v·ªÅ        |
| ---------------------------- | ------------------------------------- | ----------------------------------------------------------------------------------------------- | ------------- |
| `getByDomain()`              | T√¨m ƒë∆°n h√†ng theo domain              | `string $domain`                                                                                | `array\|null` |
| `getByMgd()`                 | T√¨m ƒë∆°n h√†ng theo MGD                 | `string $mgd`                                                                                   | `array\|null` |
| `listAll()`                  | L·∫•y danh s√°ch t·∫•t c·∫£ ƒë∆°n h√†ng         | -                                                                                               | `array`       |
| `countByStatus()`            | ƒê·∫øm ƒë∆°n h√†ng theo tr·∫°ng th√°i          | `int $status`                                                                                   | `int`         |
| `countAhihiOne()`            | ƒê·∫øm ƒë∆°n h√†ng ƒë√£ c·∫≠p nh·∫≠t DNS          | -                                                                                               | `int`         |
| `listByAhihi()`              | L·∫•y ƒë∆°n h√†ng theo tr·∫°ng th√°i DNS      | `string $value`                                                                                 | `array`       |
| `countByUserAndStatus()`     | ƒê·∫øm ƒë∆°n h√†ng c·ªßa user theo tr·∫°ng th√°i | `int $userId, int $status`                                                                      | `int`         |
| `listRecentByUser()`         | L·∫•y ƒë∆°n h√†ng g·∫ßn ƒë√¢y c·ªßa user         | `int $userId, int $limit`                                                                       | `array`       |
| `listByUser()`               | L·∫•y t·∫•t c·∫£ ƒë∆°n h√†ng c·ªßa user          | `int $userId`                                                                                   | `array`       |
| `updateStatusById()`         | C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng          | `int $id, string $status`                                                                       | `bool`        |
| `updateAhihiAndStatusById()` | C·∫≠p nh·∫≠t DNS v√† tr·∫°ng th√°i            | `int $id, string $ahihi, string $status`                                                        | `bool`        |
| `deleteById()`               | X√≥a ƒë∆°n h√†ng                          | `int $id`                                                                                       | `bool`        |
| `insertPurchase()`           | Th√™m ƒë∆°n h√†ng m·ªõi                     | `int $userId, string $domain, string $ns1, string $ns2, string $hsd, string $mgd, string $time` | `bool`        |
| `updateDns()`                | C·∫≠p nh·∫≠t DNS                          | `string $mgd, string $ns1, string $ns2, string $timedns`                                        | `bool`        |
| `getByTimedns()`             | T√¨m ƒë∆°n h√†ng theo th·ªùi gian DNS       | `string $timedns`                                                                               | `array\|null` |
| `resetTimednsById()`         | Reset th·ªùi gian DNS                   | `int $id`                                                                                       | `bool`        |
| `getByUserIdAndMgd()`        | Ki·ªÉm tra quy·ªÅn qu·∫£n l√Ω                | `int $userId, string $mgd`                                                                      | `array\|null` |

### **üìÅ C√°c file s·ª≠ d·ª•ng HistoryRepository:**

#### **1. Adminstators/duyet-don-hang.php**

```php
$historyRepo = new HistoryRepository($connect);
$historyRepo->updateStatusById((int)$_GET['true'], '1');  // Duy·ªát ƒë∆°n h√†ng
$historyRepo->updateStatusById((int)$_GET['cho'], '0');   // Ch·ªù x·ª≠ l√Ω
$historyRepo->updateStatusById((int)$_GET['false'], '2'); // T·ª´ ch·ªëi
$resultRows = $historyRepo->listAll();  // L·∫•y danh s√°ch ƒë∆°n h√†ng
$historyRepo->deleteById((int)$id);  // X√≥a ƒë∆°n h√†ng
```

**Ch·ª©c nƒÉng:** Duy·ªát ƒë∆°n h√†ng

#### **2. Adminstators/DNS.php**

```php
$historyRepo = new HistoryRepository($connect);
$resultRows = $historyRepo->listByAhihi('1');  // L·∫•y ƒë∆°n h√†ng ƒë√£ c·∫≠p nh·∫≠t DNS
```

**Ch·ª©c nƒÉng:** Qu·∫£n l√Ω DNS

#### **3. Adminstators/index.php**

```php
$factory = new RepositoryFactory($connect);
$historyRepo = $factory->history();
$pendingOrders = $historyRepo->countByStatus(0);  // ƒê·∫øm ƒë∆°n ch·ªù
$completedOrders = $historyRepo->countByStatus(1);  // ƒê·∫øm ƒë∆°n ho√†n th√†nh
```

**Ch·ª©c nƒÉng:** Dashboard th·ªëng k√™

#### **4. Pages/account_profile.php**

```php
$historyRepo = new HistoryRepository($connect);
$userOrders = $historyRepo->listByUser($user['id']);  // L·∫•y ƒë∆°n h√†ng c·ªßa user
```

**Ch·ª©c nƒÉng:** Th√¥ng tin c√° nh√¢n

#### **5. Controllers/ViewController.php**

```php
$this->historyRepo = new HistoryRepository($connect);
$orders = $this->historyRepo->listByUser($user['id']);  // L·∫•y ƒë∆°n h√†ng c·ªßa user
```

**Ch·ª©c nƒÉng:** Controller x·ª≠ l√Ω view

#### **6. Controllers/DomainController.php**

```php
$this->historyRepo = new HistoryRepository($connect);
$mgd = 'MGD' . uniqid();
$this->historyRepo->insertPurchase($user['id'], $domain, $ns1, $ns2, $hsd, $mgd, $time);  // T·∫°o ƒë∆°n h√†ng
```

**Ch·ª©c nƒÉng:** Controller x·ª≠ l√Ω domain

#### **7. Controllers/AjaxController.php**

```php
$this->historyRepo = new HistoryRepository($connect);
$orders = $this->historyRepo->listByUser($user['id']);  // L·∫•y ƒë∆°n h√†ng c·ªßa user
```

**Ch·ª©c nƒÉng:** Controller x·ª≠ l√Ω AJAX

#### **8. Controllers/AdminController.php**

```php
$this->historyRepo = new HistoryRepository($connect);
$orders = $this->historyRepo->listAll();  // L·∫•y t·∫•t c·∫£ ƒë∆°n h√†ng
```

**Ch·ª©c nƒÉng:** Controller x·ª≠ l√Ω admin

#### **9. Config/Database.php**

```php
$historyRepo = new HistoryRepository($connect);
$checkhsd = $historyRepo->getByTimedns($today);  // Ki·ªÉm tra ƒë∆°n h√†ng theo ng√†y
```

**Ch·ª©c nƒÉng:** C·∫•u h√¨nh database

#### **10. Pages/ManagesWhois.php**

```php
$historyRepo = new HistoryRepository($connect);
$rows = $historyRepo->listByUser((int)$currentUser['id']);  // L·∫•y ƒë∆°n h√†ng c·ªßa user
```

**Ch·ª©c nƒÉng:** Qu·∫£n l√Ω Whois

#### **11. Pages/managers.php**

```php
$historyRepo = new HistoryRepository($connect);
$rows = $historyRepo->listByUser((int)$currentUser['id']);  // L·∫•y ƒë∆°n h√†ng c·ªßa user
```

**Ch·ª©c nƒÉng:** Qu·∫£n l√Ω t√™n mi·ªÅn

#### **12. Ajaxs/BuyDomain.php**

```php
$historyRepo = new HistoryRepository($connect);
$mgd = 'MGD' . uniqid();
$historyRepo->insertPurchase($user['id'], $domain, $ns1, $ns2, $hsd, $mgd, $time);  // T·∫°o ƒë∆°n h√†ng
```

**Ch·ª©c nƒÉng:** Mua domain AJAX

#### **13. Ajaxs/UpdateDns.php**

```php
$historyRepo = new HistoryRepository($connect);
$order = $historyRepo->getByUserIdAndMgd($currentUser['id'], $mgd);  // Ki·ªÉm tra quy·ªÅn
$historyRepo->updateDns($mgd, $ns1, $ns2, $timedns);  // C·∫≠p nh·∫≠t DNS
```

**Ch·ª©c nƒÉng:** C·∫≠p nh·∫≠t DNS AJAX

---

## üí≥ **CARDREPOSITORY - QU·∫¢N L√ù TH·∫∫ C√ÄO**

### **üìã Danh s√°ch c√°c h√†m:**

| H√†m                           | M√¥ t·∫£                               | Tham s·ªë                                                                                                                  | Tr·∫£ v·ªÅ      |
| ----------------------------- | ----------------------------------- | ------------------------------------------------------------------------------------------------------------------------ | ----------- |
| `existsByPinSerial()`         | Ki·ªÉm tra th·∫ª ƒë√£ t·ªìn t·∫°i             | `string $pin, string $serial`                                                                                            | `bool`      |
| `insertCard()`                | Th√™m th·∫ª c√†o                        | `int $userId, string $pin, string $serial, string $type, string $amount, string $requestId, string $time, string $time2` | `bool`      |
| `listByUserId()`              | L·∫•y th·∫ª c·ªßa user                    | `int $userId`                                                                                                            | `array`     |
| `sumAmountByStatusAndTime2()` | T√≠nh doanh thu theo ng√†y            | `int $status, string $time2`                                                                                             | `int`       |
| `sumAmountByStatusAndTime3()` | T√≠nh doanh thu theo th√°ng           | `int $status, string $time3`                                                                                             | `int`       |
| `sumAmountByStatus()`         | T√≠nh doanh thu theo tr·∫°ng th√°i      | `int $status`                                                                                                            | `int`       |
| `listAll()`                   | L·∫•y t·∫•t c·∫£ th·∫ª                      | -                                                                                                                        | `array`     |
| `getUidByRequestId()`         | L·∫•y UID theo request ID             | `string $requestId`                                                                                                      | `int\|null` |
| `updateStatusByRequestId()`   | C·∫≠p nh·∫≠t tr·∫°ng th√°i theo request ID | `string $requestId, string $status`                                                                                      | `bool`      |

### **üìÅ C√°c file s·ª≠ d·ª•ng CardRepository:**

#### **1. Adminstators/Gach-Cards.php**

```php
$cardRepo = new CardRepository($connect);
$resultRows = $cardRepo->listAll();  // L·∫•y danh s√°ch t·∫•t c·∫£ th·∫ª
```

**Ch·ª©c nƒÉng:** Qu·∫£n l√Ω th·∫ª c√†o

#### **2. Adminstators/index.php**

```php
$factory = new RepositoryFactory($connect);
$cardRepo = $factory->cards();
$todayRevenue = $cardRepo->sumAmountByStatusAndTime2(1, date('d/m/Y'));  // Doanh thu h√¥m nay
$monthRevenue = $cardRepo->sumAmountByStatusAndTime3(1, date('m/Y'));  // Doanh thu th√°ng
$totalRevenue = $cardRepo->sumAmountByStatus(1);  // T·ªïng doanh thu
```

**Ch·ª©c nƒÉng:** Dashboard th·ªëng k√™ doanh thu

#### **3. Controllers/ViewController.php**

```php
$this->cardRepo = new CardRepository($connect);
$cards = $this->cardRepo->listByUserId($user['id']);  // L·∫•y th·∫ª c·ªßa user
```

**Ch·ª©c nƒÉng:** Controller x·ª≠ l√Ω view

#### **4. Controllers/AjaxController.php**

```php
$this->cardRepo = new CardRepository($connect);
$cards = $this->cardRepo->listByUserId($user['id']);  // L·∫•y th·∫ª c·ªßa user
```

**Ch·ª©c nƒÉng:** Controller x·ª≠ l√Ω AJAX

#### **5. Controllers/AdminController.php**

```php
$this->cardRepo = new CardRepository($connect);
$cards = $this->cardRepo->listAll();  // L·∫•y t·∫•t c·∫£ th·∫ª
```

**Ch·ª©c nƒÉng:** Controller x·ª≠ l√Ω admin

#### **6. Controllers/CardController.php**

```php
$this->cardRepo = new CardRepository($connect);
if (!$this->cardRepo->existsByPinSerial($pin, $serial)) {  // Ki·ªÉm tra th·∫ª ch∆∞a s·ª≠ d·ª•ng
    $this->cardRepo->insertCard($userId, $pin, $serial, $type, $amount, $requestId, $time, $time2);  // Th√™m th·∫ª
}
```

**Ch·ª©c nƒÉng:** Controller x·ª≠ l√Ω th·∫ª c√†o

#### **7. Pages/Recharge.php**

```php
$cardRepo = new CardRepository($connect);
$resultRows = $cardRepo->listByUserId((int)$users['id']);  // L·∫•y th·∫ª c·ªßa user
```

**Ch·ª©c nƒÉng:** Trang n·∫°p ti·ªÅn

#### **8. callback.php**

```php
$cardRepo = new CardRepository($connect);
$uid = $cardRepo->getUidByRequestId($requestid);  // L·∫•y UID theo request ID
$cardRepo->updateStatusByRequestId($requestid, 1);  // C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng
```

**Ch·ª©c nƒÉng:** X·ª≠ l√Ω callback t·ª´ API th·∫ª c√†o

#### **9. Ajaxs/Cards.php**

```php
$cardRepo = new CardRepository($connect);
if (!$cardRepo->existsByPinSerial($pin, $serial)) {  // Ki·ªÉm tra th·∫ª ch∆∞a s·ª≠ d·ª•ng
    $cardRepo->insertCard($user['id'], $pin, $serial, $type, $amount, $requestId, $time, $time2);  // Th√™m th·∫ª
}
```

**Ch·ª©c nƒÉng:** X·ª≠ l√Ω n·∫°p th·∫ª AJAX

---

## ‚öôÔ∏è **SETTINGSREPOSITORY - QU·∫¢N L√ù C√ÄI ƒê·∫∂T**

### **üìã Danh s√°ch c√°c h√†m:**

| H√†m                       | M√¥ t·∫£                        | Tham s·ªë                                                                                                                                 | Tr·∫£ v·ªÅ        |
| ------------------------- | ---------------------------- | --------------------------------------------------------------------------------------------------------------------------------------- | ------------- |
| `getOne()`                | L·∫•y c√†i ƒë·∫∑t hi·ªán t·∫°i         | -                                                                                                                                       | `array\|null` |
| `updateWebsiteSettings()` | C·∫≠p nh·∫≠t c√†i ƒë·∫∑t website     | `string $title, string $theme, string $keywords, string $description, string $imagebanner, string $phone, string $banner, string $logo` | `bool`        |
| `updateCardGateway()`     | C·∫≠p nh·∫≠t c√†i ƒë·∫∑t API th·∫ª c√†o | `string $apikey, string $callback, string $webgach`                                                                                     | `bool`        |

### **üìÅ C√°c file s·ª≠ d·ª•ng SettingsRepository:**

#### **1. Adminstators/cai-dat-web.php**

```php
$settingsRepo = new SettingsRepository($connect);
$settings = $settingsRepo->getOne();  // L·∫•y c√†i ƒë·∫∑t hi·ªán t·∫°i
$settingsRepo->updateWebsiteSettings($tieude, $theme, $keywords, $mota, $imagebanner, $sodienthoai, $banner, $logo);  // C·∫≠p nh·∫≠t c√†i ƒë·∫∑t
```

**Ch·ª©c nƒÉng:** C√†i ƒë·∫∑t website

#### **2. Controllers/ViewController.php**

```php
$settingsRepo = new SettingsRepository($this->connect);
$settings = $settingsRepo->getOne();  // L·∫•y c√†i ƒë·∫∑t ƒë·ªÉ hi·ªÉn th·ªã
```

**Ch·ª©c nƒÉng:** Controller x·ª≠ l√Ω view

#### **3. Controllers/AdminController.php**

```php
$this->settingsRepo = new SettingsRepository($connect);
$settings = $this->settingsRepo->getOne();  // L·∫•y c√†i ƒë·∫∑t
```

**Ch·ª©c nƒÉng:** Controller x·ª≠ l√Ω admin

#### **4. Controllers/CardController.php**

```php
$this->settingsRepo = new SettingsRepository($connect);
$settings = $this->settingsRepo->getOne();  // L·∫•y c√†i ƒë·∫∑t API
```

**Ch·ª©c nƒÉng:** Controller x·ª≠ l√Ω th·∫ª c√†o

#### **5. Config/Database.php**

```php
$settingsRepo = new SettingsRepository($connect);
$CaiDatChung = $settingsRepo->getOne();  // L·∫•y c√†i ƒë·∫∑t to√†n c·ª•c
```

**Ch·ª©c nƒÉng:** C·∫•u h√¨nh database

---

## üìä **T·ªîNG K·∫æT S·ª¨ D·ª§NG**

### **üéØ Th·ªëng k√™ s·ª≠ d·ª•ng Repository:**

| Repository             | S·ªë file s·ª≠ d·ª•ng | S·ªë h√†m ƒë∆∞·ª£c g·ªçi | M·ª•c ƒë√≠ch ch√≠nh                         |
| ---------------------- | --------------- | --------------- | -------------------------------------- |
| **UserRepository**     | 17 files        | 10/11 h√†m       | X√°c th·ª±c, qu·∫£n l√Ω user, c·∫≠p nh·∫≠t s·ªë d∆∞ |
| **DomainRepository**   | 12 files        | 7/7 h√†m         | Qu·∫£n l√Ω s·∫£n ph·∫©m, CRUD domain          |
| **HistoryRepository**  | 13 files        | 18/18 h√†m       | Qu·∫£n l√Ω ƒë∆°n h√†ng, DNS, th·ªëng k√™        |
| **CardRepository**     | 9 files         | 9/9 h√†m         | Qu·∫£n l√Ω th·∫ª c√†o, doanh thu             |
| **SettingsRepository** | 5 files         | 3/3 h√†m         | C√†i ƒë·∫∑t h·ªá th·ªëng                       |

### **üîç Ph√¢n t√≠ch m·ª©c ƒë·ªô s·ª≠ d·ª•ng:**

#### **1. UserRepository - S·ª≠ d·ª•ng nhi·ªÅu nh·∫•t:**

- **17 files** s·ª≠ d·ª•ng
- Ch·ªß y·∫øu cho **x√°c th·ª±c** v√† **qu·∫£n l√Ω user**
- H√†m `findByUsername()` ƒë∆∞·ª£c d√πng nhi·ªÅu nh·∫•t

#### **2. HistoryRepository - Ch·ª©c nƒÉng phong ph√∫ nh·∫•t:**

- **18 h√†m** ƒë∆∞·ª£c implement
- **13 files** s·ª≠ d·ª•ng
- Ch·ªß y·∫øu cho **qu·∫£n l√Ω ƒë∆°n h√†ng** v√† **DNS**

#### **3. DomainRepository - CRUD ƒë·∫ßy ƒë·ªß:**

- **12 files** s·ª≠ d·ª•ng
- **7 h√†m** CRUD ƒë·∫ßy ƒë·ªß
- Ch·ªß y·∫øu cho **qu·∫£n l√Ω s·∫£n ph·∫©m**

#### **4. CardRepository - T√≠ch h·ª£p API:**

- **9 files** s·ª≠ d·ª•ng
- **9 h√†m** chuy√™n v·ªÅ th·∫ª c√†o
- Ch·ªß y·∫øu cho **n·∫°p ti·ªÅn** v√† **callback API**

#### **5. SettingsRepository - C√†i ƒë·∫∑t h·ªá th·ªëng:**

- **5 files** s·ª≠ d·ª•ng
- **3 h√†m** c√†i ƒë·∫∑t
- Ch·ªß y·∫øu cho **c·∫•u h√¨nh website**

### **üéØ K·∫øt lu·∫≠n:**

**Repository Pattern ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng r·∫•t hi·ªáu qu·∫£ trong h·ªá th·ªëng:**

- ‚úÖ **T√°ch bi·ªát logic** - Database logic t√°ch kh·ªèi business logic
- ‚úÖ **T√°i s·ª≠ d·ª•ng cao** - M·ªói repository ƒë∆∞·ª£c d√πng ·ªü nhi·ªÅu n∆°i
- ‚úÖ **Ch·ª©c nƒÉng ƒë·∫ßy ƒë·ªß** - CRUD operations ho√†n ch·ªânh
- ‚úÖ **B·∫£o m·∫≠t t·ªët** - Prepared statements 100%
- ‚úÖ **D·ªÖ maintain** - Code c√≥ c·∫•u tr√∫c r√µ r√†ng

**T√°c gi·∫£:** DAM THANH VU  
**Ng√†y t·∫°o:** 2024  
**Phi√™n b·∫£n:** 1.0
